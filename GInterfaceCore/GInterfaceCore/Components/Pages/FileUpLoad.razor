<h3>Cargar Archivo CSV</h3>

<InputFile OnChange="HandleFileSelected" accept=".csv, .xlsx, .xls" />
<br />
@if (!string.IsNullOrEmpty(UploadedContent))
{
    <h4>Tamaño del archivo: @FileSizeInKB KB</h4>
    <RadzenButton Click=@(args => OnClick("Primary button")) Text="Ok" ButtonStyle="ButtonStyle.Primary" />
    //Tengo que hacer que el boton on con la funcion Onclick cierre el boton y
    //ejecute la carga de datos en la base
}


@code {
    private string UploadedContent { get; set; } = string.Empty;
    private long FileSizeInBytes { get; set; }
    private double FileSizeInKB => FileSizeInBytes / 1024.0;
    private Core.AppCore _appCore = Core.AppCore.Instance;
    private Core.Utils.ExcelParse _excel= new Core.Utils.ExcelParse();
    // private Core.Utils.ExcelParse _excel= Core.Utils.ExcelParse.;
    string[] csvFile;
    string[] headers;

    [Parameter]
    public FileCSV SomeParameter { get; set; } // Cambia 'FileCSV' al tipo que necesitas


    private void OnClick(string text)
    {
        _appCore.InsertFileCsv(_appCore.CFileName, _appCore.fileStatus, _appCore.head, _appCore.ObjJason, _appCore.InfotTempo, _appCore.inbound);
        DialogService.Close();
        NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Info, Summary = "Button Clicked", Detail = text });
    }


    private async Task UploadFile(InputFileChangeEventArgs e)
    {
        var saveFolder = Path.Combine("C:\\Temp\\Files");
        var filePath = Path.Combine(saveFolder, e.File.Name);
        Directory.CreateDirectory(saveFolder);

        await using FileStream fs = new(filePath, FileMode.Create);
        await e.File.OpenReadStream().CopyToAsync(fs);
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        var fileName = file.Name;

        if (file != null)
        {
            FileSizeInBytes = file.Size;

            try
            {
                // Abre el stream del archivo (límite de 100 MB)
                using (var stream = file.OpenReadStream(104857600))
                {
                    // Verifica si es un archivo de Excel
                    if (fileName.Contains(".xls", StringComparison.OrdinalIgnoreCase) ||
                        fileName.Contains(".xlsx", StringComparison.OrdinalIgnoreCase))
                    {


                        // Mostrar modal para pedir el tamaño del header
                        //var result = await DialogService.OpenAsync<HeaderSizeDialog>("Tamaño del Encabezado",
                        //new Dictionary<string, object>() { { "FileName", fileName } },
                        //new DialogOptions() { Width = "500px", Height = "300px" });

                        var result =SomeParameter;
                        
                        var listJson = _appCore.TemplateJson(result);
                        if (result != null)
                        {
                            // Asumiendo que listJson.StartEndHead es de tipo List<object>
                            List<string> stringList = listJson.StartEndHead
                            .Select(o => o?.ToString() ?? string.Empty) // Convertir a string, manejando null
                            .ToList();




                            InvokeAsync(async () =>
                                {
                                    // Simulate background task
                                List<List<string>> informationExcel = await _excel.SimulateFileUpload(stream, fileName, int.Parse(stringList[0]), stringList[1], stringList[2], listJson.RequireFields);
                                if (informationExcel == null || !_appCore.validDocument)
                                {
                                    // Cancelar el diálogo actual
                                    DialogService.Close();

                                    // Abrir otro modal, puedes usar DialogService.Open para abrir un nuevo diálogo
                                    await DialogService.OpenComponentExtension<ErrorDocument>("Nuevo Modal", null);  // Reemplaza 'YourNewModal' por tu componente

                                    // Salir de la ejecución para no continuar con el proceso
                                    return;
                                }
                                var info = stringList[1] + "," + stringList[2];
                                    _appCore.sortDataExcel(informationExcel, fileName, listJson.RequireFields, info);
                                    UploadedContent = "a";
                                    _appCore.inbound = result.InboundOutbound;
                                    // Close the dialog
                                    DialogService.Close();
                                });
                                await BusyDialog();  
                                      
                            
                            
                        }
                        else
                        {
                            // Si el resultado es null, se asumirá que el usuario canceló
                            return;
                        }

                    }
                    else
                    {
                        // Solo leer el archivo si no es Excel
                        using (var reader = new StreamReader(stream))
                        {
                            UploadedContent = await reader.ReadToEndAsync();

                            // Procesar el archivo CSV
                            csvFile = UploadedContent.Split(Environment.NewLine.ToCharArray(), StringSplitOptions.RemoveEmptyEntries);
                            _appCore.sortData(csvFile, fileName);
                            headers = csvFile[0].Split(',');
                        }
                    }
                }

                if (headers != null)
                {
                    await ShowFieldInfoDialog(headers.Length, headers);
                }

                NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Info,
                        Summary = $"{file.Name}",
                        Detail = $"{FileSizeInKB} KB",
                        Duration = 4000,


                    });
            }
            catch (Exception ex)
            {
                UploadedContent = $"Error al leer el archivo: {ex.Message}";
                NotificationService.Notify(new NotificationMessage
                        {
                            Severity = NotificationSeverity.Error,
                            Summary = "Error al leer el archivo",
                            Detail = ex.Message
                        });
            }
        }
        else
        {
            UploadedContent = "No se seleccionó ningún archivo.";
            NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = "Error en seleccion",
                        Detail = UploadedContent
                    });
        }
    }

    // Busy dialog from markup
    async Task BusyDialog()
    {
        await DialogService.OpenAsync("", ds =>
    @<RadzenStack AlignItems="AlignItems.Center" Gap="2rem" class="rz-p-12">
        <RadzenImage Path="images/loading.gif" Style="width: 200px;" AlternateText="community" />
        <RadzenText TextStyle="TextStyle.H6">Cargando meta informacion...</RadzenText>
    </RadzenStack>, new DialogOptions() { ShowTitle = false, Style = "min-height:auto;min-width:auto;width:auto", CloseDialogOnEsc = false });
    }

    private async Task ShowFieldInfoDialog(int fieldCount, string[] fields)
    {
        var message = $"El archivo CSV contiene {fieldCount} campos.\n\nCampos:\n{string.Join("\n", fields)}";        
    }
    
    
}
